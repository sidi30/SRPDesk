package com.lexsecura.domain.model;

import org.junit.jupiter.api.Test;

import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

class VulnerabilityReportTest {

    private final UUID orgId = UUID.randomUUID();

    @Test
    void submit_shouldCreateNewReport() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-001", "XSS Bug", "Description",
                "Alice", "alice@test.com", false);

        assertEquals(VulnerabilityReport.Status.NEW, report.getStatus());
        assertEquals("VR-2026-001", report.getTrackingId());
        assertEquals("XSS Bug", report.getTitle());
        assertEquals("Alice", report.getReporterName());
        assertNotNull(report.getSubmittedAt());
    }

    @Test
    void submit_anonymous_shouldClearReporterInfo() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-002", "Bug", "Desc",
                "Hidden", "hidden@test.com", true);

        assertTrue(report.isAnonymous());
        assertNull(report.getReporterName());
        assertNull(report.getReporterEmail());
    }

    @Test
    void fullWorkflow_newToDisclosed() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-003", "Bug", "Desc", "R", "r@t.com", false);

        report.acknowledge();
        assertEquals(VulnerabilityReport.Status.ACKNOWLEDGED, report.getStatus());
        assertNotNull(report.getAcknowledgedAt());

        report.startTriage();
        assertEquals(VulnerabilityReport.Status.TRIAGING, report.getStatus());

        report.confirm();
        assertEquals(VulnerabilityReport.Status.CONFIRMED, report.getStatus());

        report.startFixing();
        assertEquals(VulnerabilityReport.Status.FIXING, report.getStatus());

        report.markFixed();
        assertEquals(VulnerabilityReport.Status.FIXED, report.getStatus());
        assertNotNull(report.getFixedAt());

        report.disclose();
        assertEquals(VulnerabilityReport.Status.DISCLOSED, report.getStatus());
        assertNotNull(report.getDisclosedAt());
    }

    @Test
    void reject_fromTriaging() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-004", "Bug", "Desc", "R", "r@t.com", false);
        report.acknowledge();
        report.startTriage();

        report.reject("Not a vulnerability");

        assertEquals(VulnerabilityReport.Status.REJECTED, report.getStatus());
        assertEquals("Not a vulnerability", report.getInternalNotes());
    }

    @Test
    void disclose_fromRejected() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-005", "Bug", "Desc", "R", "r@t.com", false);
        report.acknowledge();
        report.startTriage();
        report.reject("False positive");

        report.disclose();
        assertEquals(VulnerabilityReport.Status.DISCLOSED, report.getStatus());
    }

    @Test
    void acknowledge_fromNonNew_shouldThrow() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-006", "Bug", "Desc", "R", "r@t.com", false);
        report.acknowledge();

        assertThrows(IllegalStateException.class, report::acknowledge);
    }

    @Test
    void confirm_fromNonTriaging_shouldThrow() {
        VulnerabilityReport report = VulnerabilityReport.submit(
                orgId, "VR-2026-007", "Bug", "Desc", "R", "r@t.com", false);

        assertThrows(IllegalStateException.class, report::confirm);
    }
}
