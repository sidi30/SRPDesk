package com.lexsecura.api.controller;

import com.lexsecura.application.dto.VulnerabilityImpactResponse;
import com.lexsecura.application.dto.VulnerabilityImpactResponse.AffectedRelease;
import com.lexsecura.domain.model.Finding;
import com.lexsecura.domain.model.FindingDecision;
import com.lexsecura.domain.model.Vulnerability;
import com.lexsecura.domain.repository.*;
import com.lexsecura.infrastructure.security.TenantContext;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/v1/vulnerabilities")
public class VulnerabilityImpactController {

    private final VulnerabilityRepository vulnerabilityRepository;
    private final FindingRepository findingRepository;
    private final FindingDecisionRepository findingDecisionRepository;
    private final ReleaseRepository releaseRepository;
    private final ProductRepository productRepository;

    public VulnerabilityImpactController(
            VulnerabilityRepository vulnerabilityRepository,
            FindingRepository findingRepository,
            FindingDecisionRepository findingDecisionRepository,
            ReleaseRepository releaseRepository,
            ProductRepository productRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
        this.findingRepository = findingRepository;
        this.findingDecisionRepository = findingDecisionRepository;
        this.releaseRepository = releaseRepository;
        this.productRepository = productRepository;
    }

    @GetMapping("/impact")
    public ResponseEntity<VulnerabilityImpactResponse> getImpact(@RequestParam String cve) {
        UUID orgId = TenantContext.getOrgId();

        Vulnerability vuln = vulnerabilityRepository.findByOsvId(cve).orElse(null);
        if (vuln == null) {
            return ResponseEntity.notFound().build();
        }

        List<Finding> findings = findingRepository.findAllByVulnerabilityId(vuln.getId());
        List<AffectedRelease> affected = new ArrayList<>();

        for (Finding finding : findings) {
            releaseRepository.findByIdAndOrgId(finding.getReleaseId(), orgId).ifPresent(release -> {
                String productName = productRepository.findByIdAndOrgId(release.getProductId(), orgId)
                        .map(p -> p.getName())
                        .orElse("Unknown");

                List<FindingDecision> decisions = findingDecisionRepository.findAllByFindingId(finding.getId());
                String latestDecision = decisions.isEmpty() ? null
                        : decisions.get(decisions.size() - 1).getDecisionType();

                affected.add(new AffectedRelease(
                        release.getId(),
                        release.getProductId(),
                        productName,
                        release.getVersion(),
                        finding.getId(),
                        finding.getStatus(),
                        latestDecision
                ));
            });
        }

        return ResponseEntity.ok(new VulnerabilityImpactResponse(
                vuln.getOsvId(),
                vuln.getSummary(),
                vuln.getSeverity(),
                vuln.getCvssScore(),
                vuln.getCvssVector(),
                vuln.isActivelyExploited(),
                vuln.getKevDateAdded(),
                vuln.getEuvdId(),
                affected
        ));
    }
}
