package com.lexsecura.infrastructure.vulnerability;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;

/**
 * ENISA European Vulnerability Database (EUVD) client.
 * European differentiator â€” maps CVEs to EUVD IDs.
 */
@Component
public class EuvdClient implements VulnerabilitySource {

    private static final Logger log = LoggerFactory.getLogger(EuvdClient.class);
    private static final String EUVD_BASE = "https://euvd.enisa.europa.eu/api";

    private final WebClient webClient;
    private final ObjectMapper objectMapper;

    public EuvdClient(ObjectMapper objectMapper) {
        this.webClient = WebClient.builder().baseUrl(EUVD_BASE).build();
        this.objectMapper = objectMapper;
    }

    @Override
    public String name() {
        return "EUVD";
    }

    @Override
    public List<VulnerabilityMatch> checkCves(List<String> cveIds) {
        List<VulnerabilityMatch> results = new ArrayList<>();
        for (String cveId : cveIds) {
            try {
                String json = webClient.get()
                        .uri("/v1/vulnerabilities?cve=" + cveId)
                        .retrieve()
                        .bodyToMono(String.class)
                        .block(Duration.ofSeconds(15));

                JsonNode root = objectMapper.readTree(json);
                JsonNode items = root.path("items");
                if (items.isArray() && !items.isEmpty()) {
                    JsonNode item = items.get(0);
                    String euvdId = item.path("id").asText(null);
                    if (euvdId != null) {
                        results.add(new VulnerabilityMatch(
                                cveId, "EUVD", false, null, euvdId, null, null, null, null
                        ));
                    }
                }
                Thread.sleep(1000); // Rate limiting
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                break;
            } catch (Exception e) {
                log.debug("EUVD lookup failed for {}: {}", cveId, e.getMessage());
            }
        }
        return results;
    }
}
