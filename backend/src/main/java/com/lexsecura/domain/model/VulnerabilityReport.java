package com.lexsecura.domain.model;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.UUID;

public class VulnerabilityReport {

    public enum Status {
        NEW, ACKNOWLEDGED, TRIAGING, CONFIRMED, REJECTED, FIXING, FIXED, DISCLOSED
    }

    private UUID id;
    private UUID orgId;
    private UUID productId;
    private String trackingId;
    private Status status;

    // Reporter info
    private String reporterName;
    private String reporterEmail;
    private String reporterPgpFingerprint;
    private boolean anonymous;

    // Vulnerability details
    private String title;
    private String description;
    private String severityEstimate;
    private String affectedComponent;
    private String affectedVersions;
    private String stepsToReproduce;
    private String proofOfConcept;

    // Internal triage
    private UUID assignedTo;
    private String internalNotes;
    private String internalSeverity;
    private BigDecimal cvssScore;
    private String cveId;

    // Timestamps
    private Instant submittedAt;
    private Instant acknowledgedAt;
    private Instant triagedAt;
    private Instant fixedAt;
    private Instant disclosedAt;
    private Instant disclosureDeadline;
    private Instant createdAt;
    private Instant updatedAt;

    public VulnerabilityReport() {}

    /** Creates a new report from a public submission. */
    public static VulnerabilityReport submit(UUID orgId, String trackingId, String title, String description,
                                              String reporterName, String reporterEmail, boolean anonymous) {
        VulnerabilityReport vr = new VulnerabilityReport();
        vr.orgId = orgId;
        vr.trackingId = trackingId;
        vr.status = Status.NEW;
        vr.title = title;
        vr.description = description;
        vr.reporterName = anonymous ? null : reporterName;
        vr.reporterEmail = anonymous ? null : reporterEmail;
        vr.anonymous = anonymous;
        vr.submittedAt = Instant.now();
        return vr;
    }

    public void acknowledge() {
        if (this.status != Status.NEW) {
            throw new IllegalStateException("Can only acknowledge NEW reports, current: " + this.status);
        }
        this.status = Status.ACKNOWLEDGED;
        this.acknowledgedAt = Instant.now();
    }

    public void startTriage() {
        if (this.status != Status.ACKNOWLEDGED) {
            throw new IllegalStateException("Can only start triage from ACKNOWLEDGED, current: " + this.status);
        }
        this.status = Status.TRIAGING;
        this.triagedAt = Instant.now();
    }

    public void confirm() {
        if (this.status != Status.TRIAGING) {
            throw new IllegalStateException("Can only confirm from TRIAGING, current: " + this.status);
        }
        this.status = Status.CONFIRMED;
    }

    public void reject(String reason) {
        if (this.status != Status.TRIAGING) {
            throw new IllegalStateException("Can only reject from TRIAGING, current: " + this.status);
        }
        this.status = Status.REJECTED;
        this.internalNotes = reason;
    }

    public void startFixing() {
        if (this.status != Status.CONFIRMED) {
            throw new IllegalStateException("Can only start fixing from CONFIRMED, current: " + this.status);
        }
        this.status = Status.FIXING;
    }

    public void markFixed() {
        if (this.status != Status.FIXING) {
            throw new IllegalStateException("Can only mark fixed from FIXING, current: " + this.status);
        }
        this.status = Status.FIXED;
        this.fixedAt = Instant.now();
    }

    public void disclose() {
        if (this.status != Status.FIXED && this.status != Status.REJECTED) {
            throw new IllegalStateException("Can only disclose from FIXED or REJECTED, current: " + this.status);
        }
        this.status = Status.DISCLOSED;
        this.disclosedAt = Instant.now();
    }

    // Getters & Setters
    public UUID getId() { return id; }
    public void setId(UUID id) { this.id = id; }
    public UUID getOrgId() { return orgId; }
    public void setOrgId(UUID orgId) { this.orgId = orgId; }
    public UUID getProductId() { return productId; }
    public void setProductId(UUID productId) { this.productId = productId; }
    public String getTrackingId() { return trackingId; }
    public void setTrackingId(String trackingId) { this.trackingId = trackingId; }
    public Status getStatus() { return status; }
    public void setStatus(Status status) { this.status = status; }
    public String getReporterName() { return reporterName; }
    public void setReporterName(String reporterName) { this.reporterName = reporterName; }
    public String getReporterEmail() { return reporterEmail; }
    public void setReporterEmail(String reporterEmail) { this.reporterEmail = reporterEmail; }
    public String getReporterPgpFingerprint() { return reporterPgpFingerprint; }
    public void setReporterPgpFingerprint(String reporterPgpFingerprint) { this.reporterPgpFingerprint = reporterPgpFingerprint; }
    public boolean isAnonymous() { return anonymous; }
    public void setAnonymous(boolean anonymous) { this.anonymous = anonymous; }
    public String getTitle() { return title; }
    public void setTitle(String title) { this.title = title; }
    public String getDescription() { return description; }
    public void setDescription(String description) { this.description = description; }
    public String getSeverityEstimate() { return severityEstimate; }
    public void setSeverityEstimate(String severityEstimate) { this.severityEstimate = severityEstimate; }
    public String getAffectedComponent() { return affectedComponent; }
    public void setAffectedComponent(String affectedComponent) { this.affectedComponent = affectedComponent; }
    public String getAffectedVersions() { return affectedVersions; }
    public void setAffectedVersions(String affectedVersions) { this.affectedVersions = affectedVersions; }
    public String getStepsToReproduce() { return stepsToReproduce; }
    public void setStepsToReproduce(String stepsToReproduce) { this.stepsToReproduce = stepsToReproduce; }
    public String getProofOfConcept() { return proofOfConcept; }
    public void setProofOfConcept(String proofOfConcept) { this.proofOfConcept = proofOfConcept; }
    public UUID getAssignedTo() { return assignedTo; }
    public void setAssignedTo(UUID assignedTo) { this.assignedTo = assignedTo; }
    public String getInternalNotes() { return internalNotes; }
    public void setInternalNotes(String internalNotes) { this.internalNotes = internalNotes; }
    public String getInternalSeverity() { return internalSeverity; }
    public void setInternalSeverity(String internalSeverity) { this.internalSeverity = internalSeverity; }
    public BigDecimal getCvssScore() { return cvssScore; }
    public void setCvssScore(BigDecimal cvssScore) { this.cvssScore = cvssScore; }
    public String getCveId() { return cveId; }
    public void setCveId(String cveId) { this.cveId = cveId; }
    public Instant getSubmittedAt() { return submittedAt; }
    public void setSubmittedAt(Instant submittedAt) { this.submittedAt = submittedAt; }
    public Instant getAcknowledgedAt() { return acknowledgedAt; }
    public void setAcknowledgedAt(Instant acknowledgedAt) { this.acknowledgedAt = acknowledgedAt; }
    public Instant getTriagedAt() { return triagedAt; }
    public void setTriagedAt(Instant triagedAt) { this.triagedAt = triagedAt; }
    public Instant getFixedAt() { return fixedAt; }
    public void setFixedAt(Instant fixedAt) { this.fixedAt = fixedAt; }
    public Instant getDisclosedAt() { return disclosedAt; }
    public void setDisclosedAt(Instant disclosedAt) { this.disclosedAt = disclosedAt; }
    public Instant getDisclosureDeadline() { return disclosureDeadline; }
    public void setDisclosureDeadline(Instant disclosureDeadline) { this.disclosureDeadline = disclosureDeadline; }
    public Instant getCreatedAt() { return createdAt; }
    public void setCreatedAt(Instant createdAt) { this.createdAt = createdAt; }
    public Instant getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(Instant updatedAt) { this.updatedAt = updatedAt; }
}
