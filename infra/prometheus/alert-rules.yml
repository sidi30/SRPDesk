groups:
  - name: srpdesk-backend
    rules:
      # Backend down
      - alert: BackendDown
        expr: up{job="srpdesk-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "SRPDesk backend is down"
          description: "Le backend ne repond plus depuis 1 minute."

      # Taux d'erreur HTTP > 5%
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m]))
            /
            sum(rate(http_server_requests_seconds_count[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'erreur HTTP > 5%"
          description: "{{ $value | humanizePercentage }} des requetes retournent une erreur 5xx."

      # Latence p99 > 2 secondes
      - alert: HighLatency
        expr: histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Latence p99 > 2s"
          description: "La latence p99 est de {{ $value }}s."

      # Heap JVM > 85%
      - alert: HighJvmHeapUsage
        expr: |
          jvm_memory_used_bytes{area="heap"}
          /
          jvm_memory_max_bytes{area="heap"} > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Usage heap JVM > 85%"
          description: "La heap JVM utilise {{ $value | humanizePercentage }} de la memoire max."

      # Pool Hikari epuise (connexions actives proches du max)
      - alert: HikariPoolExhausted
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.9
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Pool Hikari presque epuise"
          description: "{{ $value | humanizePercentage }} des connexions BDD sont actives."

  - name: srpdesk-infra
    rules:
      # PostgreSQL down
      - alert: PostgresDown
        expr: up{job="postgres-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL est down"
          description: "L'exporter PostgreSQL ne repond plus."

      # PostgreSQL connexions > 80% du max
      - alert: PostgresConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Connexions PostgreSQL > 80% du max"

      # Caddy down
      - alert: CaddyDown
        expr: up{job="caddy"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Caddy reverse proxy is down"
