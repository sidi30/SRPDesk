name: Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image tag to deploy (e.g. v1.2.0, latest)'
        required: true
        default: 'latest'

env:
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/srpdesk

jobs:
  deploy:
    name: Deploy ${{ inputs.version }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/srpdesk

            # Set the version to pull
            export IMAGE_TAG=${{ inputs.version }}

            # Pull specific version
            docker pull ${{ env.IMAGE_PREFIX }}-backend:${IMAGE_TAG}
            docker pull ${{ env.IMAGE_PREFIX }}-frontend:${IMAGE_TAG}
            docker pull ${{ env.IMAGE_PREFIX }}-landing:${IMAGE_TAG}

            # Tag as current
            docker tag ${{ env.IMAGE_PREFIX }}-backend:${IMAGE_TAG} ${{ env.IMAGE_PREFIX }}-backend:current
            docker tag ${{ env.IMAGE_PREFIX }}-frontend:${IMAGE_TAG} ${{ env.IMAGE_PREFIX }}-frontend:current
            docker tag ${{ env.IMAGE_PREFIX }}-landing:${IMAGE_TAG} ${{ env.IMAGE_PREFIX }}-landing:current

            # Restart services
            docker compose -f docker-compose.prod.yml up -d --no-deps backend frontend landing

            # Cleanup
            docker image prune -f

      - name: Deployment summary
        run: |
          echo "### Deployed \`${{ inputs.version }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Image |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend | \`${{ env.IMAGE_PREFIX }}-backend:${{ inputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend | \`${{ env.IMAGE_PREFIX }}-frontend:${{ inputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Landing | \`${{ env.IMAGE_PREFIX }}-landing:${{ inputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
