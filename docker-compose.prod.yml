services:
  # ==========================================================================
  # REVERSE PROXY — Caddy (HTTPS automatique via Let's Encrypt)
  # ==========================================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"   # HTTP/3
    environment:
      APP_DOMAIN: ${APP_DOMAIN:-app.localhost}
      AUTH_DOMAIN: ${AUTH_DOMAIN:-auth.localhost}
      LANDING_DOMAIN: ${LANDING_DOMAIN:-www.localhost}
      MONITORING_DOMAIN: ${MONITORING_DOMAIN:-monitoring.localhost}
      MONITORING_USER: ${MONITORING_USER:-admin}
      MONITORING_PASSWORD_HASH: ${MONITORING_PASSWORD_HASH}
      ACME_EMAIL: ${ACME_EMAIL:-admin@srpdesk.com}
    volumes:
      - ./infra/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      frontend:
        condition: service_started
      landing:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: ${CADDY_MEMORY_LIMIT:-128m}
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # BASE DE DONNEES — PostgreSQL 16
  # ==========================================================================
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    deploy:
      resources:
        limits:
          memory: ${POSTGRES_MEMORY_LIMIT:-512m}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # AUTHENTIFICATION — Keycloak 24 (OIDC)
  # ==========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    restart: unless-stopped
    command: start --optimized --import-realm
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_HOSTNAME: ${AUTH_DOMAIN}
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
    volumes:
      - ./infra/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    deploy:
      resources:
        limits:
          memory: ${KEYCLOAK_MEMORY_LIMIT:-768m}
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200'"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 60s

  # ==========================================================================
  # STOCKAGE S3 — MinIO
  # ==========================================================================
  minio:
    image: minio/minio:latest
    restart: "no"
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    deploy:
      resources:
        limits:
          memory: ${MINIO_MEMORY_LIMIT:-256m}
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb local/${S3_BUCKET} --ignore-existing;
      echo 'Bucket ${S3_BUCKET} created';
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: ${S3_BUCKET}

  # ==========================================================================
  # BACKEND — Spring Boot (Java 21)
  # ==========================================================================
  backend:
    image: ${IMAGE_PREFIX}-backend:${IMAGE_TAG:-latest}
    build:
      context: ./backend
    restart: unless-stopped
    environment:
      # --- Spring profile ---
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # --- Base de donnees ---
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${DB_NAME:-srpdesk}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_MAX: ${DB_POOL_MAX:-30}
      DB_POOL_MIN: ${DB_POOL_MIN:-10}
      DB_POOL_CONNECTION_TIMEOUT: ${DB_POOL_CONNECTION_TIMEOUT:-20000}
      # --- OIDC ---
      KEYCLOAK_ISSUER_URI: ${KEYCLOAK_ISSUER_URI}
      KEYCLOAK_JWK_URI: ${KEYCLOAK_JWK_URI}
      # --- S3 ---
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-evidences}
      S3_REGION: ${S3_REGION:-us-east-1}
      # --- Core ---
      SERVER_PORT: ${SERVER_PORT:-8080}
      CORS_ORIGINS: ${CORS_ORIGINS}
      APP_NAME: ${APP_NAME:-srpdesk}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-50MB}
      MAX_REQUEST_SIZE: ${MAX_REQUEST_SIZE:-55MB}
      # --- Tomcat ---
      TOMCAT_MAX_THREADS: ${TOMCAT_MAX_THREADS:-200}
      TOMCAT_ACCEPT_COUNT: ${TOMCAT_ACCEPT_COUNT:-100}
      # --- Rate limiting ---
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_RPM: ${RATE_LIMIT_RPM:-60}
      RATE_LIMIT_CVD_RPM: ${RATE_LIMIT_CVD_RPM:-5}
      # --- Email ---
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@srpdesk.com}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_AUTH: ${SMTP_AUTH:-false}
      SMTP_STARTTLS: ${SMTP_STARTTLS:-true}
      # --- CRA ---
      CRA_NOTIFICATION_CHECK_MS: ${CRA_NOTIFICATION_CHECK_MS:-900000}
      CRA_ESCALATION_CHECK_MS: ${CRA_ESCALATION_CHECK_MS:-300000}
      CRA_ALERT_EMAIL: ${CRA_ALERT_EMAIL:-}
      CRA_ESCALATION_EMAIL: ${CRA_ESCALATION_EMAIL:-}
      # --- ENISA SRP ---
      ENISA_ENABLED: ${ENISA_ENABLED:-false}
      ENISA_BASE_URL: ${ENISA_BASE_URL:-https://srp.enisa.europa.eu}
      ENISA_API_KEY: ${ENISA_API_KEY:-}
      ENISA_TIMEOUT: ${ENISA_TIMEOUT:-30}
      # --- CSIRT ---
      CSIRT_ENABLED: ${CSIRT_ENABLED:-false}
      CSIRT_BASE_URL: ${CSIRT_BASE_URL:-}
      CSIRT_API_KEY: ${CSIRT_API_KEY:-}
      CSIRT_TIMEOUT: ${CSIRT_TIMEOUT:-30}
      CSIRT_COUNTRY_CODE: ${CSIRT_COUNTRY_CODE:-FR}
      # --- Monitoring vulnerabilites ---
      MONITORING_INTERVAL_MS: ${MONITORING_INTERVAL_MS:-21600000}
      OSV_BASE_URL: ${OSV_BASE_URL:-https://api.osv.dev}
      OSV_BATCH_SIZE: ${OSV_BATCH_SIZE:-100}
      OSV_RATE_LIMIT_MS: ${OSV_RATE_LIMIT_MS:-1000}
      # --- CVD ---
      CVD_CONTACT_EMAIL: ${CVD_CONTACT_EMAIL:-security@srpdesk.com}
      # --- Support monitoring ---
      SUPPORT_MONITOR_WARNING_DAYS: ${SUPPORT_MONITOR_WARNING_DAYS:-90}
      # --- AI / Ollama ---
      AI_ENABLED: ${AI_ENABLED:-false}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-phi3.5}
      OLLAMA_TEMPERATURE: ${OLLAMA_TEMPERATURE:-0.2}
      OLLAMA_TOP_P: ${OLLAMA_TOP_P:-0.9}
      OLLAMA_NUM_CTX: ${OLLAMA_NUM_CTX:-4096}
      OLLAMA_TIMEOUT: ${OLLAMA_TIMEOUT:-120}
      AI_RATE_LIMIT_RPM: ${AI_RATE_LIMIT_RPM:-10}
      # --- Webhooks ---
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
      GITLAB_WEBHOOK_SECRET: ${GITLAB_WEBHOOK_SECRET:-}
      # --- API Keys ---
      API_KEY_PREFIX: ${API_KEY_PREFIX:-srpd_}
      API_KEY_LENGTH: ${API_KEY_LENGTH:-20}
      API_KEY_SCOPES: ${API_KEY_SCOPES:-ci:sbom}
      # --- SBOM ---
      SBOM_MAX_SIZE_MB: ${SBOM_MAX_SIZE_MB:-10}
      # --- Feature flags ---
      EXTRAS_REQUIREMENTS_ENABLED: ${EXTRAS_REQUIREMENTS_ENABLED:-false}
      EXTRAS_QUESTIONNAIRE_ENABLED: ${EXTRAS_QUESTIONNAIRE_ENABLED:-false}
      # --- Observabilite ---
      OTEL_SAMPLING_PROBABILITY: ${OTEL_SAMPLING_PROBABILITY:-1.0}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://localhost:4318/v1/traces}
      # --- JVM ---
      JAVA_OPTS: ${JAVA_OPTS:-}
    deploy:
      resources:
        limits:
          memory: ${BACKEND_MEMORY_LIMIT:-768m}
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${SERVER_PORT:-8080}/actuator/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # FRONTEND — React + nginx (proxy API vers backend)
  # ==========================================================================
  frontend:
    image: ${IMAGE_PREFIX}-frontend:${IMAGE_TAG:-latest}
    build:
      context: ./frontend
    restart: unless-stopped
    # Pas de ports exposes — Caddy fait le reverse proxy
    depends_on:
      backend:
        condition: service_healthy

  # ==========================================================================
  # LANDING — Site vitrine Next.js (static export + nginx)
  # ==========================================================================
  landing:
    image: ${IMAGE_PREFIX}-landing:${IMAGE_TAG:-latest}
    build:
      context: ./landing
    restart: unless-stopped
    # Pas de ports exposes — Caddy fait le reverse proxy

  # ==========================================================================
  # MONITORING — Prometheus
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}'
      - '--web.enable-lifecycle'
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infra/prometheus/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus-data:/prometheus
    deploy:
      resources:
        limits:
          memory: ${PROMETHEUS_MEMORY_LIMIT:-256m}
    depends_on:
      backend:
        condition: service_healthy

  # ==========================================================================
  # MONITORING — PostgreSQL Exporter (metriques BDD pour Prometheus)
  # ==========================================================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable"
    deploy:
      resources:
        limits:
          memory: 64m
    depends_on:
      postgres:
        condition: service_healthy

  # ==========================================================================
  # BACKUP — Sauvegarde PostgreSQL automatisee (cron quotidien)
  # ==========================================================================
  backup:
    image: postgres:16
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Backup service started — schedule: ${BACKUP_CRON:-0 2 * * *}"
        # Installer cron dans le conteneur PostgreSQL
        apt-get update -qq && apt-get install -y -qq cron > /dev/null 2>&1
        # Ecrire le cron job
        echo "${BACKUP_CRON:-0 2 * * *} /scripts/backup.sh >> /var/log/backup.log 2>&1" > /etc/cron.d/backup
        chmod 0644 /etc/cron.d/backup
        crontab /etc/cron.d/backup
        # Executer un backup initial au demarrage
        /scripts/backup.sh
        # Lancer cron en foreground
        cron -f
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    volumes:
      - ./infra/backup/backup.sh:/scripts/backup.sh:ro
      - srpdesk-backups:/backups
    deploy:
      resources:
        limits:
          memory: ${BACKUP_MEMORY_LIMIT:-128m}
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  pgdata:
  minio-data:
  caddy-data:
  caddy-config:
  prometheus-data:
  srpdesk-backups:
